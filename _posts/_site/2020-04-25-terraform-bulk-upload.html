<h1 id="overview">Overview</h1>

<p>DynamoDB is great!  It can be used for routing and metadata table, be used to lock Terraform State files, track states of applicatins and much more!  This post will offer a solution for populating the data within a DynamoDB table at create-rime, entirely within Terraform.</p>

<p>The issue I am lokking to solve here is to providion a DynamoDB lookup table without from Terraform, without involving extra steps that Terraform can not invoke, without a ton of extra work, and something that can be easily re-produceable and scalable.</p>

<p>The code is available here for thsoe who just wnat to get to the solution:  https://github.com/jacob-hudson/terraform-bulk-upload</p>

<h1 id="current-problem">Current Problem</h1>

<p>Provisiong an empty DynamoDB table in Terraform is quite easy, an example is below:</p>

<figure class="highlight"><pre><code class="language-hcl" data-lang="hcl"><span class="nx">resource</span> <span class="s2">"aws_dynamodb_table"</span> <span class="s2">"basic-dynamodb-table"</span> <span class="p">{</span>
  <span class="nx">name</span>           <span class="p">=</span> <span class="s2">"GameScores"</span>
  <span class="nx">billing_mode</span>   <span class="p">=</span> <span class="s2">"PROVISIONED"</span>
  <span class="nx">read_capacity</span>  <span class="p">=</span> <span class="mi">20</span>
  <span class="nx">write_capacity</span> <span class="p">=</span> <span class="mi">20</span>
  <span class="nx">hash_key</span>       <span class="p">=</span> <span class="s2">"UserId"</span>
  <span class="nx">range_key</span>      <span class="p">=</span> <span class="s2">"GameTitle"</span>

  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"UserId"</span>
    <span class="nx">type</span> <span class="p">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>

  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"GameTitle"</span>
    <span class="nx">type</span> <span class="p">=</span> <span class="s2">"S"</span>
  <span class="p">}</span>

  <span class="nx">attribute</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="p">=</span> <span class="s2">"TopScore"</span>
    <span class="nx">type</span> <span class="p">=</span> <span class="s2">"N"</span>
  <span class="p">}</span>

  <span class="nx">ttl</span> <span class="p">{</span>
    <span class="nx">attribute_name</span> <span class="p">=</span> <span class="s2">"TimeToExist"</span>
    <span class="nx">enabled</span>        <span class="p">=</span> <span class="kc">false</span>
  <span class="p">}</span>

  <span class="nx">global_secondary_index</span> <span class="p">{</span>
    <span class="nx">name</span>               <span class="p">=</span> <span class="s2">"GameTitleIndex"</span>
    <span class="nx">hash_key</span>           <span class="p">=</span> <span class="s2">"GameTitle"</span>
    <span class="nx">range_key</span>          <span class="p">=</span> <span class="s2">"TopScore"</span>
    <span class="nx">write_capacity</span>     <span class="p">=</span> <span class="mi">10</span>
    <span class="nx">read_capacity</span>      <span class="p">=</span> <span class="mi">10</span>
    <span class="nx">projection_type</span>    <span class="p">=</span> <span class="s2">"INCLUDE"</span>
    <span class="nx">non_key_attributes</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"UserId"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="nx">tags</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">Name</span>        <span class="p">=</span> <span class="s2">"dynamodb-table-1"</span>
    <span class="nx">Environment</span> <span class="p">=</span> <span class="s2">"production"</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Source:  https://www.terraform.io/docs/providers/aws/r/dynamodb_table.html</p>

<p>This will result in a blank table, that has to be managed later.  Hashicorp does offer a solution for managing DynamoDB Iteams, as shown below:</p>

<figure class="highlight"><pre><code class="language-hcl" data-lang="hcl"><span class="nx">resource</span> <span class="s2">"aws_dynamodb_table_item"</span> <span class="s2">"example"</span> <span class="p">{</span>
  <span class="nx">table_name</span> <span class="p">=</span> <span class="s2">"${aws_dynamodb_table.example.name}"</span>
  <span class="nx">hash_key</span>   <span class="p">=</span> <span class="s2">"${aws_dynamodb_table.example.hash_key}"</span>

  <span class="nx">item</span> <span class="p">=</span> <span class="o">&lt;&lt;</span><span class="no">ITEM</span><span class="sh">
{
  "exampleHashKey": {"S": "something"},
  "one": {"N": "11111"},
  "two": {"N": "22222"},
  "three": {"N": "33333"},
  "four": {"N": "44444"}
}
</span><span class="no">ITEM
</span><span class="p">}</span></code></pre></figure>

<p>This works quite well, but is limited to one item per resource.  That does not scale well, and produces massive Terraform Configuratinn files.  In fact, the Terraform Documentation itself gives the same warning:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Note: This resource is not meant to be used for managing large amounts of data in your table, it is not designed to scale. You should perform regular backups of all data in the table, see AWS docs for more.
</code></pre></div></div>

<p>This is clearly not an optiaml solution, so what can be done?  Letâ€™s see what AWS has to offer, since DynamoDB is an AWS Product</p>

<h1 id="putitem-vs-batchwriteitem"><code class="highlighter-rouge">PutItem</code> vs <code class="highlighter-rouge">BatchWriteItem</code></h1>

<p>DynamoDB offers a fwe mthods for writing data to tables, <code class="highlighter-rouge">PutItem</code> and <code class="highlighter-rouge">BatchWriteItem</code>.  Some key details of each is below:</p>

<h2 id="putitem"><code class="highlighter-rouge">PutItem</code></h2>
<ul>
  <li>Is used to upload a single item</li>
  <li>Can determine if the field exists before uploading</li>
</ul>

<h2 id="batchwriteitem"><code class="highlighter-rouge">BatchWriteItem</code></h2>
<ul>
  <li>Can upload many items to a table at once</li>
  <li>Will simply overwite all items that ahve matching Primary Keys</li>
</ul>

<p>It looks as we have a working solution, as <code class="highlighter-rouge">BatchWriteItem</code> will load as many items into a table as we like, will be able to do everything at once, and we can centralize data managment of the table.</p>

<p>Now, how can we get this to be invovled solely from Terraform?</p>

<h1 id="local-exec-provisoner"><code class="highlighter-rouge">Local-Exec</code> Provisoner</h1>

<p>A privisioner in Terraform allows for the execution of a file into either the local machine running Terraform for the machine Terraform just provisioned.  In a little known fact for Terraform, <code class="highlighter-rouge">local-exec</code> will run on any resource, not just EC2!</p>

<p>An example of using local-exec with EC2 is below:</p>

<figure class="highlight"><pre><code class="language-hcl" data-lang="hcl"><span class="nx">resource</span> <span class="s2">"aws_instance"</span> <span class="s2">"web"</span> <span class="p">{</span>
  <span class="c1"># ...</span>

  <span class="nx">provisioner</span> <span class="s2">"local-exec"</span> <span class="p">{</span>
    <span class="nx">command</span> <span class="p">=</span> <span class="s2">"echo The server's IP address is ${self.private_ip}"</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The example above is for EC2; However, <code class="highlighter-rouge">local-exec</code> can run for any AWS resource, including DynamoDB!</p>

<h1 id="solution">Solution</h1>
<p>Alright, so we now have the following:</p>
<ul>
  <li>A Terraform Configuration to Build a DynamoDB Table</li>
  <li>A Method for uploading multiple items to said table</li>
  <li>A Solution for executing the dataload from Terraform</li>
</ul>

<p>The only thing left now is to put everything together!</p>

<p>In this example,  i ahve rpovisoned a very simple DynamoDB table, with 1 unite of Read and Write cataptiy, no encryption, no streams, and no Autoscaling.  Within the DynamoDB resource, I invoke the <code class="highlighter-rouge">local-exec</code> provisoner to kick off a Shell script on the same machine that is running Terrafrom (which also has the AWSCLI installed), this will run <code class="highlighter-rouge">BactchWriteItem</code> for the table I just created and load all of the sample data.</p>

